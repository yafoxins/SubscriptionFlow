{% extends "base.html" %}

{% block title %}Дашборд - Subscription Manager{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/dashboard.css">

<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-tachometer-alt mr-3"></i>Дашборд
                </h1>
                <p class="text-gray-600" id="welcomeUser">Добро пожаловать!</p>
            </div>
            <div class="flex gap-3 items-center">
                <button onclick="openAddModal()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">
                    <i class="fas fa-plus mr-2"></i>Добавить подписку
                </button>
                <button onclick="refreshDashboard()"
                    class="btn-secondary text-gray-700 px-4 py-3 rounded-lg font-medium" title="Обновить данные">
                    <i class="fas fa-sync-alt mr-2"></i>Обновить
                </button>
                <button id="openNotifyModalBtn" class="btn-primary text-white px-6 py-3 rounded-lg font-medium hidden">
                    <i class="fas fa-bullhorn mr-2"></i>Уведомление всем
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid md:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="bg-purple-100 p-3 rounded-lg">
                    <i class="fas fa-list text-2xl text-purple-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Всего подписок</p>
                    <p class="text-2xl font-bold text-gray-900" id="totalSubscriptions">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="bg-green-100 p-3 rounded-lg">
                    <i class="fas fa-check-circle text-2xl text-green-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Активные</p>
                    <p class="text-2xl font-bold text-gray-900" id="activeSubscriptions">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="bg-blue-100 p-3 rounded-lg">
                    <i class="fas fa-calendar-alt text-2xl text-blue-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Месячные расходы</p>
                    <p class="text-2xl font-bold text-gray-900" id="monthlyCost">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="bg-orange-100 p-3 rounded-lg">
                    <i class="fas fa-calendar text-2xl text-orange-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Годовые расходы</p>
                    <p class="text-2xl font-bold text-gray-900" id="yearlyCost">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Subscriptions List -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-list mr-2"></i>Мои подписки
                    </h2>
                </div>
                <div class="p-6">
                    <div id="subscriptionsList" class="space-y-4">
                        <!-- Subscriptions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Upcoming Bills -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-clock mr-2"></i>Предстоящие платежи
                    </h3>
                </div>
                <div class="p-6">
                    <div id="upcomingBills" class="space-y-3">
                        <!-- Upcoming bills will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-bell mr-2"></i>Уведомления
                    </h3>
                    <div class="flex gap-2 items-center">
                        <button id="clearNotificationsBtn"
                            class="ml-2 p-2 rounded-full bg-red-50 hover:bg-red-100 text-red-500"
                            title="Очистить все уведомления"><i class="fas fa-trash"></i></button>
                        <button id="openNotifyModalBtn"
                            class="btn-primary text-white px-4 py-2 rounded-md font-medium hidden">
                            <i class="fas fa-bullhorn mr-2"></i>Уведомление всем
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div id="notificationsList" class="space-y-3">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Subscription Modal -->
<div id="addModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal-backdrop hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-plus mr-2"></i>Добавить подписку
                </h3>
            </div>
            <form id="addSubscriptionForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Название</label>
                    <input type="text" id="subscriptionName" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Описание</label>
                    <textarea id="subscriptionDescription" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Цена</label>
                        <input type="number" id="subscriptionPrice" step="0.01" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Валюта</label>
                        <select id="subscriptionCurrency"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none bg-white">
                            <option value="RUB">RUB</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Цикл оплаты</label>
                        <select id="subscriptionBillingCycle" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 appearance-none bg-white">
                            <option value="monthly">Ежемесячно</option>
                            <option value="yearly">Ежегодно</option>
                            <option value="weekly">Еженедельно</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Категория</label>
                        <div class="flex gap-2">
                            <div id="customCategoryDropdown" class="custom-dropdown flex-1" tabindex="0" data-value="">
                                <div class="custom-dropdown-selected">
                                    <span class="custom-dropdown-icon"><i class="fas fa-tag"></i></span>
                                    <span class="custom-dropdown-text">Без категории</span>
                                    <span class="custom-dropdown-arrow"><i class="fas fa-chevron-down"></i></span>
                                </div>
                                <ul class="custom-dropdown-list hidden max-h-60 overflow-y-auto">
                                    <li data-value=""><span class="custom-dropdown-icon"><i
                                                class="fas fa-tag"></i></span>Без категории</li>
                                    <li data-value="streaming"><span class="custom-dropdown-icon"><i
                                                class="fas fa-film"></i></span>Стриминг</li>
                                    <li data-value="software"><span class="custom-dropdown-icon"><i
                                                class="fas fa-laptop-code"></i></span>Программное обеспечение</li>
                                    <li data-value="music"><span class="custom-dropdown-icon"><i
                                                class="fas fa-music"></i></span>Музыка</li>
                                    <li data-value="gaming"><span class="custom-dropdown-icon"><i
                                                class="fas fa-gamepad"></i></span>Игры</li>
                                    <li data-value="education"><span class="custom-dropdown-icon"><i
                                                class="fas fa-graduation-cap"></i></span>Образование</li>
                                    <li data-value="fitness"><span class="custom-dropdown-icon"><i
                                                class="fas fa-dumbbell"></i></span>Фитнес</li>
                                    <li data-value="news"><span class="custom-dropdown-icon"><i
                                                class="fas fa-newspaper"></i></span>Новости</li>
                                    <li data-value="productivity"><span class="custom-dropdown-icon"><i
                                                class="fas fa-tasks"></i></span>Продуктивность</li>
                                    <li data-value="security"><span class="custom-dropdown-icon"><i
                                                class="fas fa-shield-alt"></i></span>Безопасность</li>
                                    <li data-value="storage"><span class="custom-dropdown-icon"><i
                                                class="fas fa-cloud"></i></span>Хранилище</li>
                                    <li data-value="other"><span class="custom-dropdown-icon"><i
                                                class="fas fa-ellipsis-h"></i></span>Другое</li>
                                </ul>
                            </div>
                            <button type="button" onclick="detectCategory()"
                                class="px-3 py-2 bg-purple-100 text-purple-700 rounded-md hover:bg-purple-200 transition-colors flex items-center gap-1"
                                title="Умное определение категории по названию">
                                <i class="fas fa-magic"></i>
                                <span class="text-xs">AI</span>
                            </button>
                        </div>
                        <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                            <i class="fas fa-info-circle"></i>
                            <span>Выберите категорию вручную или используйте умное определение</span>
                        </div>
                        <input type="hidden" id="subscriptionCategory" name="subscriptionCategory" value="">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Следующий платеж</label>
                    <input type="datetime-local" id="subscriptionNextBilling" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Сайт (необязательно)</label>
                    <input type="url" id="subscriptionWebsite"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAddModal()"
                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Отмена
                    </button>
                    <button type="submit" class="btn-primary text-white px-4 py-2 rounded-md">
                        <i class="fas fa-save mr-2"></i>Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно отправки уведомления всем -->
<div id="notifyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal-backdrop hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200 flex items-center gap-2">
                <i class="fas fa-bullhorn text-purple-600 text-xl"></i>
                <h3 class="text-lg font-semibold text-gray-900">Отправить уведомление всем</h3>
            </div>
            <form id="notifyAllForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Текст уведомления</label>
                    <textarea id="notifyMessage" rows="3" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeNotifyModal()"
                        class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">Отмена</button>
                    <button type="submit" class="btn-primary text-white px-4 py-2 rounded-md"><i
                            class="fas fa-paper-plane mr-2"></i>Отправить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения действия -->
<div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal-backdrop hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200 flex items-center gap-2">
                <span id="confirmIcon"></span>
                <h3 class="text-lg font-semibold text-gray-900" id="confirmTitle">Подтвердите действие</h3>
            </div>
            <div class="p-6 text-gray-700" id="confirmText">Вы уверены?</div>
            <div class="flex justify-end space-x-3 pt-4 pb-2 px-6">
                <button type="button" onclick="closeConfirmModal()"
                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">Нет</button>
                <button type="button" id="confirmYesBtn" class="px-4 py-2 text-white rounded-md">Да</button>
            </div>
        </div>
    </div>
</div>

<!-- Кастомное модальное окно подтверждения для удаления всех уведомлений -->
<div id="clearNotifModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 modal-backdrop hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200 flex items-center gap-2">
                <i class="fas fa-trash text-red-500 text-xl"></i>
                <h3 class="text-lg font-semibold text-gray-900">Удалить все уведомления?</h3>
            </div>
            <div class="p-6 text-gray-700">Вы действительно хотите удалить все уведомления? Это действие необратимо.
            </div>
            <div class="flex justify-end space-x-3 p-6 pt-0">
                <button type="button" onclick="closeClearNotifModal()"
                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">Отмена</button>
                <button type="button" id="clearNotifYesBtn"
                    class="px-4 py-2 text-white rounded-md bg-red-600 hover:bg-red-700">Удалить</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Иконки категорий должны быть определены до использования
    const categoryIcons = {
        'streaming': '<i class="fas fa-film"></i>',
        'software': '<i class="fas fa-laptop-code"></i>',
        'music': '<i class="fas fa-music"></i>',
        'gaming': '<i class="fas fa-gamepad"></i>',
        'education': '<i class="fas fa-graduation-cap"></i>',
        'fitness': '<i class="fas fa-dumbbell"></i>',
        'news': '<i class="fas fa-newspaper"></i>',
        'productivity': '<i class="fas fa-tasks"></i>',
        'security': '<i class="fas fa-shield-alt"></i>',
        'storage': '<i class="fas fa-cloud"></i>',
        'other': '<i class="fas fa-ellipsis-h"></i>',
        '': '<i class="fas fa-tag"></i>',
    };
    // Русский перевод для billing_cycle
    const billingCycleMap = {
        'monthly': 'Ежемесячно',
        'yearly': 'Ежегодно',
        'weekly': 'Еженедельно',
        'daily': 'Ежедневно',
        'once': 'Разово',
    };
    // Русский перевод для категорий
    const categoryMap = {
        'streaming': 'Стриминг',
        'software': 'Программное обеспечение',
        'music': 'Музыка',
        'gaming': 'Игры',
        'other': 'Другое',
        '': 'Без категории',
    };
    // Склонение слова "день"
    function pluralizeDays(n) {
        n = Math.abs(n);
        if (n % 10 === 1 && n % 100 !== 11) return 'день';
        if ([2, 3, 4].includes(n % 10) && ![12, 13, 14].includes(n % 100)) return 'дня';
        return 'дней';
    }

    // Load dashboard data
    async function loadDashboard() {
        console.log('Loading dashboard...');
        try {
            // Добавляем параметр для принудительного обновления кэша
            const timestamp = new Date().getTime();
            const response = await fetch(`/api/dashboard/stats?t=${timestamp}`, {
                headers: getAuthHeaders()
            });
            console.log('Dashboard stats response:', response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('Dashboard data:', data);

                // Update stats
                document.getElementById('totalSubscriptions').textContent = data.total_subscriptions;
                document.getElementById('activeSubscriptions').textContent = data.active_subscriptions;
                document.getElementById('monthlyCost').textContent = `${data.total_monthly_cost} ₽`;
                document.getElementById('yearlyCost').textContent = `${data.total_yearly_cost} ₽`;

                // Load subscriptions
                await loadSubscriptions();

                // Load upcoming bills
                loadUpcomingBills(data.upcoming_bills);

                // Load notifications
                await loadNotifications();

                // Set welcome user
                setWelcomeUser();
            } else if (response.status === 401) {
                console.log('Unauthorized, clearing token and redirecting to login');
                localStorage.removeItem('token');
                window.location.href = '/login';
                return;
            } else {
                console.error('Dashboard stats error:', response.status, response.statusText);
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
        }
    }

    // Load subscriptions
    async function loadSubscriptions() {
        console.log('Loading subscriptions...');
        try {
            const response = await fetch('/api/subscriptions/', {
                headers: getAuthHeaders()
            });
            console.log('Subscriptions response:', response.status);

            if (response.ok) {
                const subscriptions = await response.json();
                console.log('Subscriptions data:', subscriptions);
                const container = document.getElementById('subscriptionsList');

                if (subscriptions.length === 0) {
                    container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>У вас пока нет подписок</p>
                        <button onclick="openAddModal()" class="btn-primary text-white px-4 py-2 rounded-md mt-4">
                            <i class="fas fa-plus mr-2"></i>Добавить первую подписку
                        </button>
                    </div>
                `;
                } else {
                    container.innerHTML = subscriptions.map(sub => {
                        const isActive = sub.is_active !== false; // по умолчанию true, если нет поля
                        const status = isActive ? '<span class="sub-status active" title="Активна"><i class="fas fa-circle"></i> Активна</span>' : '<span class="sub-status inactive" title="Неактивна"><i class="fas fa-circle"></i> Неактивна</span>';
                        const nextPay = (() => {
                            const days = sub.days_until_billing;
                            if (days === 0) return '<span class="next-badge soon">завтра</span>';
                            if (days === 1) return '<span class="next-badge soon">послезавтра</span>';
                            if (typeof days === 'number' && days > 1) return `<span class='next-badge'>через ${days} ${pluralizeDays(days)}</span>`;
                            return `<span class='next-badge'>${new Date(sub.next_billing_date).toLocaleDateString()}</span>`;
                        })();
                        return `
                        <div class="subscription-card${isActive ? '' : ' subscription-inactive'}">
                            <div class="subscription-info">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="subscription-title">${sub.name}</div>
                                    ${status}
                                </div>
                                ${sub.description ? `<div class="subscription-desc">${sub.description}</div>` : ''}
                                <div class="subscription-meta">
                                    <span class="category-badge ${sub.category}">${categoryIcons[sub.category] || categoryIcons['']} ${categoryMap[sub.category] || 'Без категории'}</span>
                                    <span><i class="fas fa-calendar mr-1"></i>${billingCycleMap[sub.billing_cycle] || sub.billing_cycle}</span>
                                    ${sub.website_url ? `<a href="${sub.website_url}" class="subscription-link site-icon" target="_blank" rel="noopener" title="${sub.website_url}"><i class="fas fa-globe"></i></a>` : ''}
                                </div>
                            </div>
                            <div class="flex flex-col items-end justify-between min-w-[120px] gap-2">
                                <div class="subscription-price-block">
                                    <div class="subscription-price-badge">${sub.price} ${sub.currency}</div>
                                </div>
                                <div class="subscription-next-block">
                                    <div class="subscription-next-label">Следующий платёж</div>
                                    <div class="subscription-next">${nextPay}</div>
                                </div>
                                <div class="subscription-actions mt-2">
                                    ${isActive ? `
                                        <button onclick="editSubscription(${sub.id})" class="icon-btn edit-btn" title="Изменить"><i class="fas fa-edit"></i></button>
                                        <button onclick="syncToCalendar(${sub.id})" class="icon-btn calendar-btn opacity-60 hover:opacity-80" title="Интеграция с календарями (в разработке)"><i class="fas fa-calendar-plus"></i></button>
                                        <button onclick="deleteSubscription(${sub.id})" class="icon-btn delete-btn" title="Удалить"><i class="fas fa-trash"></i></button>
                                        <button onclick="deactivateSubscription(${sub.id})" class="icon-btn deactivate-btn" title="Деактивировать"><i class="fas fa-power-off"></i></button>
                                    ` : `
                                        <button onclick="reactivateSubscription(${sub.id})" class="icon-btn reactivate-btn" title="Возобновить"><i class="fas fa-redo"></i> Возобновить</button>
                                    `}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            } else {
                console.error('Subscriptions error:', response.status, response.statusText);
            }
        } catch (error) {
            console.error('Error loading subscriptions:', error);
        }
    }

    // --- Предстоящие платежи ---
    function loadUpcomingBills(bills) {
        bills.sort((a, b) => new Date(a.next_billing_date) - new Date(b.next_billing_date));
        const container = document.getElementById('upcomingBills');
        if (bills.length === 0) {
            container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <p>Нет предстоящих платежей</p>
            </div>
        `;
        } else {
            container.innerHTML = bills.map(bill => {
                let days = bill.days_until_billing;
                let daysText = '';
                if (days === 0) daysText = 'завтра';
                else if (days === 1) daysText = 'послезавтра';
                else daysText = `через ${days} ${pluralizeDays(days)}`;
                return `
            <div class="upcoming-bill-card">
                <div>
                    <div class="bill-title">${bill.name}</div>
                    <div class="text-sm text-gray-600">${bill.price} ${bill.currency}</div>
                </div>
                <div class="text-right">
                    <div class="bill-date">${new Date(bill.next_billing_date).toLocaleDateString()}</div>
                    <div class="bill-days">${daysText}</div>
                </div>
            </div>
        `;
            }).join('');
        }
    }
    // --- Уведомления ---
    async function loadNotifications() {
        try {
            const response = await fetch('/api/dashboard/notifications', {
                headers: getAuthHeaders()
            });
            if (response.ok) {
                const notifications = await response.json();
                const container = document.getElementById('notificationsList');
                if (notifications.length === 0) {
                    container.innerHTML = `
                <div class="notifications-empty">
                    <i class="fas fa-bell-slash"></i>
                    <div>Нет уведомлений</div>
                    <div class="text-xs text-gray-400">Здесь будут появляться напоминания о предстоящих платежах, изменениях и важных событиях.</div>
                </div>
            `;
                } else {
                    container.innerHTML = notifications.map(notif => {
                        // Определяем тип уведомления: если subscription_id === null, это админское
                        const isAdmin = notif.subscription_name === '' || notif.subscription_id === null;
                        const cardClass = isAdmin ? 'notification-card admin' : 'notification-card system';
                        const badge = isAdmin ? '<span class="notif-badge">Админ</span>' : '';
                        const icon = isAdmin ? '<i class="fas fa-bullhorn"></i>' : '<i class="fas fa-bell"></i>';
                        return `
                    <div class="${cardClass}">
                        <span class="notif-icon">${icon}</span>
                        <div class="notif-content">
                            <div class="text-sm text-gray-900">${notif.message} ${badge}</div>
                            <div class="notif-date">${new Date(notif.created_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                    `;
                    }).join('');
                }
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    // Modal functions
    // --- Кастомный dropdown для категории ---
    function initCategoryDropdown(selectedValue = '') {
        const dropdown = document.getElementById('customCategoryDropdown');
        const hiddenInput = document.getElementById('subscriptionCategory');
        const selectedText = dropdown.querySelector('.custom-dropdown-text');
        const selectedIcon = dropdown.querySelector('.custom-dropdown-icon');
        const list = dropdown.querySelector('.custom-dropdown-list');
        const items = list.querySelectorAll('li');

        // Установить выбранное значение
        let found = false;
        items.forEach(li => {
            if (li.dataset.value === selectedValue) {
                selectedText.textContent = li.textContent.trim();
                selectedIcon.innerHTML = li.querySelector('.custom-dropdown-icon').innerHTML;
                hiddenInput.value = li.dataset.value;
                found = true;
            }
        });
        if (!found) {
            // fallback: первая категория
            const first = items[0];
            selectedText.textContent = first.textContent.trim();
            selectedIcon.innerHTML = first.querySelector('.custom-dropdown-icon').innerHTML;
            hiddenInput.value = first.dataset.value;
        }
        // Открытие/закрытие
        dropdown.onclick = function (e) {
            e.stopPropagation();
            list.classList.toggle('hidden');
            dropdown.classList.toggle('open');
        };
        // Выбор
        items.forEach(li => {
            li.onclick = function (e) {
                e.stopPropagation();
                selectedText.textContent = this.textContent.trim();
                selectedIcon.innerHTML = this.querySelector('.custom-dropdown-icon').innerHTML;
                hiddenInput.value = this.dataset.value;
                list.classList.add('hidden');
                dropdown.classList.remove('open');
            };
        });
        // Закрытие при клике вне
        document.addEventListener('click', function handler(e) {
            if (!dropdown.contains(e.target)) {
                list.classList.add('hidden');
                dropdown.classList.remove('open');
            }
        }, { once: true });
    }
    // --- При открытии модалки ---
    function openAddModal() {
        document.getElementById('addModal').classList.remove('hidden');
        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('subscriptionNextBilling').value = tomorrow.toISOString().slice(0, 16);
        // Сброс категории на 'Без категории'
        document.getElementById('subscriptionCategory').value = '';
        // Инициализируем dropdown с небольшой задержкой
        setTimeout(() => {
            initCategoryDropdown('');
        }, 50);
    }
    // --- При редактировании ---
    let editingSubscriptionId = null;
    async function editSubscription(id) {
        try {
            const response = await fetch(`/api/subscriptions/${id}`, {
                headers: getAuthHeaders()
            });
            if (response.ok) {
                const sub = await response.json();
                document.getElementById('subscriptionName').value = sub.name;
                document.getElementById('subscriptionDescription').value = sub.description || '';
                document.getElementById('subscriptionPrice').value = sub.price;
                document.getElementById('subscriptionCurrency').value = sub.currency;
                document.getElementById('subscriptionBillingCycle').value = sub.billing_cycle;
                document.getElementById('subscriptionNextBilling').value = sub.next_billing_date.slice(0, 16);
                document.getElementById('subscriptionWebsite').value = sub.website_url || '';
                editingSubscriptionId = id;
                document.getElementById('addModal').classList.remove('hidden');
                // Категория с небольшой задержкой
                setTimeout(() => {
                    initCategoryDropdown(sub.category || '');
                }, 50);
            } else {
                showToast('Ошибка загрузки подписки', 'error');
            }
        } catch (error) {
            showToast('Ошибка соединения', 'error');
        }
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.add('hidden');
        document.getElementById('addSubscriptionForm').reset();
        // Сбрасываем кастомный dropdown к начальному состоянию с небольшой задержкой
        setTimeout(() => {
            initCategoryDropdown('');
        }, 50);
        editingSubscriptionId = null;
    }

    // Add subscription form
    document.getElementById('addSubscriptionForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = {
            name: document.getElementById('subscriptionName').value,
            description: document.getElementById('subscriptionDescription').value,
            price: parseFloat(document.getElementById('subscriptionPrice').value),
            currency: document.getElementById('subscriptionCurrency').value,
            billing_cycle: document.getElementById('subscriptionBillingCycle').value,
            next_billing_date: document.getElementById('subscriptionNextBilling').value,
            category: document.getElementById('subscriptionCategory').value,
            website_url: document.getElementById('subscriptionWebsite').value
        };

        try {
            let response;
            if (editingSubscriptionId) {
                // Редактирование
                response = await fetch(`/api/subscriptions/${editingSubscriptionId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });
            } else {
                // Добавление
                response = await fetch('/api/subscriptions/', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });
            }

            if (response.ok) {
                closeAddModal();
                // Принудительно обновляем данные
                await loadDashboard();
                // Показываем уведомление об успехе
                showToast(editingSubscriptionId ? 'Подписка обновлена!' : 'Подписка успешно добавлена!', 'success');
            } else {
                const error = await response.json();
                showToast('Ошибка: ' + (error.detail || 'Неизвестная ошибка'), 'error');
            }
        } catch (error) {
            showToast('Ошибка соединения', 'error');
        } finally {
            editingSubscriptionId = null;
        }
    });

    // --- Кастомное модальное подтверждение ---
    let confirmAction = null;
    function showConfirmModal({ title, text, icon, yesClass, onYes }) {
        document.getElementById('confirmTitle').textContent = title || 'Подтвердите действие';
        document.getElementById('confirmText').textContent = text || 'Вы уверены?';
        document.getElementById('confirmIcon').innerHTML = icon || '';
        const yesBtn = document.getElementById('confirmYesBtn');
        yesBtn.className = 'px-4 py-2 text-white rounded-md ' + (yesClass || 'bg-purple-600 hover:bg-purple-700');
        confirmAction = onYes;
        document.getElementById('confirmModal').classList.remove('hidden');
    }
    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        confirmAction = null;
    }
    document.getElementById('confirmYesBtn').onclick = function () {
        if (confirmAction) confirmAction();
        closeConfirmModal();
    };
    // --- Переопределяем удаление и деактивацию ---
    async function deleteSubscription(id) {
        showConfirmModal({
            title: 'Удалить подписку?',
            text: 'Вы действительно хотите удалить эту подписку? Это действие необратимо.',
            icon: '<i class="fas fa-trash text-red-500 text-2xl"></i>',
            yesClass: 'bg-red-600 hover:bg-red-700',
            onYes: async () => {
                try {
                    const response = await fetch(`/api/subscriptions/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    if (response.ok) {
                        await loadDashboard();
                        showToast('Подписка успешно удалена!', 'success');
                    } else {
                        showToast('Ошибка при удалении подписки', 'error');
                    }
                } catch (error) {
                    showToast('Ошибка соединения', 'error');
                }
            }
        });
    }
    async function deactivateSubscription(id) {
        showConfirmModal({
            title: 'Отключить подписку?',
            text: 'Вы уверены, что хотите временно отключить эту подписку? Её можно будет возобновить позже.',
            icon: '<i class="fas fa-power-off text-yellow-500 text-2xl"></i>',
            yesClass: 'bg-yellow-400 hover:bg-yellow-500 text-gray-900',
            onYes: async () => {
                try {
                    const response = await fetch(`/api/subscriptions/${id}`, {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ is_active: false })
                    });
                    if (response.ok) {
                        await loadDashboard();
                        showToast('Подписка деактивирована', 'success');
                    } else {
                        showToast('Ошибка при деактивации', 'error');
                    }
                } catch (error) {
                    showToast('Ошибка соединения', 'error');
                }
            }
        });
    }
    // --- Возобновление подписки ---
    async function reactivateSubscription(id) {
        try {
            const response = await fetch(`/api/subscriptions/${id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ is_active: true })
            });
            if (response.ok) {
                await loadDashboard();
                showToast('Подписка возобновлена!', 'success');
            } else {
                showToast('Ошибка при возобновлении', 'error');
            }
        } catch (error) {
            showToast('Ошибка соединения', 'error');
        }
    }

    // Умное определение категории
    async function detectCategory() {
        const nameInput = document.getElementById('subscriptionName');
        const descriptionInput = document.getElementById('subscriptionDescription');

        if (!nameInput || !descriptionInput) {
            console.error('Required form elements not found');
            showToast('Ошибка: форма не найдена', 'error');
            return;
        }

        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();

        console.log('detectCategory called with:', { name, description });

        if (!name) {
            showToast('Введите название подписки для определения категории', 'warning');
            return;
        }

        try {
            const requestData = { name, description };
            console.log('Sending category detection request:', requestData);

            const response = await fetch('/api/subscriptions/detect-category', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...getAuthHeaders()
                },
                body: JSON.stringify(requestData)
            });

            if (response.ok) {
                const result = await response.json();
                if (result.category) {
                    // Обновляем dropdown с определенной категорией
                    const dropdown = document.getElementById('customCategoryDropdown');
                    const selectedText = dropdown.querySelector('.custom-dropdown-text');
                    const selectedIcon = dropdown.querySelector('.custom-dropdown-icon');
                    const hiddenInput = document.getElementById('subscriptionCategory');

                    // Находим элемент с определенной категорией
                    const items = dropdown.querySelectorAll('li');
                    items.forEach(li => {
                        if (li.dataset.value === result.category) {
                            selectedText.textContent = li.textContent.trim();
                            selectedIcon.innerHTML = li.querySelector('.custom-dropdown-icon').innerHTML;
                            hiddenInput.value = li.dataset.value;
                        }
                    });

                    showToast(`Категория определена: ${result.name}. Вы можете изменить её вручную, если нужно.`, 'success');
                } else {
                    showToast('Не удалось определить категорию', 'warning');
                }
            } else {
                console.error('Category detection error:', response.status, response.statusText);
                try {
                    const errorData = await response.json();
                    console.error('Error details:', errorData);
                    if (response.status === 422) {
                        showToast(`Ошибка валидации: ${errorData.detail || 'Неверные данные'}`, 'error');
                    } else {
                        showToast(`Ошибка определения категории: ${errorData.detail || 'Неизвестная ошибка'}`, 'error');
                    }
                } catch (parseError) {
                    console.error('Error parsing error response:', parseError);
                    showToast('Ошибка определения категории', 'error');
                }
            }
        } catch (error) {
            console.error('Category detection network error:', error);
            showToast('Ошибка соединения', 'error');
        }
    }

    // Интеграция с календарями (в разработке)
    async function syncToCalendar(subscriptionId) {
        // Создаем красивый toast с сообщением "в разработке"
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-4 rounded-lg shadow-2xl transform translate-x-full transition-transform duration-300 z-50 max-w-sm';
        toast.innerHTML = `
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-tools text-xl"></i>
                </div>
                <div class="ml-3 flex-1">
                    <div class="font-semibold">Интеграция с календарями</div>
                    <div class="text-sm opacity-90 mt-1">Функция находится в разработке. Скоро вы сможете добавлять подписки в Google Calendar и Outlook!</div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white opacity-70 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        document.body.appendChild(toast);

        // Анимация появления
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);

        // Автоматическое скрытие через 6 секунд
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toast.parentElement) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 6000);
    }

    // Toast уведомления
    // showToast теперь поддерживает стек, плавную анимацию, разные типы, автоудаление, иконки
    function showToast(message, type = 'success', timeout = 3500) {
        let container = document.getElementById('toastContainer');
        if (!container) {
            // Если по какой-то причине контейнер не найден, создаём его внизу body
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.style.position = 'fixed';
            container.style.right = '2.2em';
            container.style.bottom = '2.2em';
            container.style.zIndex = '1200';
            document.body.appendChild(container);
        }
        const toast = document.createElement('div');
        let icon = '';
        let toastType = type;
        if (type === 'success') icon = '<span class="toast-icon"><i class="fas fa-check-circle" style="color:#22c55e"></i></span>';
        else if (type === 'error') icon = '<span class="toast-icon"><i class="fas fa-times-circle" style="color:#ef4444"></i></span>';
        else if (type === 'admin') { icon = '<span class="toast-icon"><i class="fas fa-bullhorn" style="color:#f59e42"></i></span>'; toastType = 'admin'; }
        else icon = '<span class="toast-icon"><i class="fas fa-info-circle" style="color:#6366f1"></i></span>';
        toast.className = `toast toast-${toastType}`;
        toast.innerHTML = `${icon}<span>${message}</span><button onclick=\"this.parentNode.classList.remove('show');this.parentNode.classList.add('hide');setTimeout(()=>this.parentNode.remove(),300);\">×</button>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.classList.add('hide');
            setTimeout(() => toast.remove(), 350);
        }, timeout);
    }

    // Check authentication
    function checkAuth() {
        const token = getToken();
        console.log('Token:', token ? 'exists' : 'missing');
        if (!token) {
            console.log('No token found, redirecting to login');
            window.location.href = '/login';
            return false;
        }
        // Проверяем срок действия токена
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const now = Math.floor(Date.now() / 1000);
            if (payload.exp && payload.exp < now) {
                console.log('Token expired, redirecting to login');
                localStorage.removeItem('token');
                window.location.href = '/login';
                return false;
            }
        } catch (e) {
            console.log('Invalid token format, redirecting to login');
            localStorage.removeItem('token');
            window.location.href = '/login';
            return false;
        }
        return true;
    }

    // --- Безопасный getToken ---
    function getToken() {
        return (typeof localStorage !== 'undefined') ? localStorage.getItem('token') : null;
    }

    // Функция принудительного обновления дашборда
    async function refreshDashboard() {
        console.log('Forcing dashboard refresh...');
        try {
            // Очищаем кэш на клиенте
            localStorage.removeItem('dashboard_cache');

            // Принудительно обновляем данные
            await loadDashboard();
            showToast('Данные обновлены', 'success');
        } catch (error) {
            console.error('Error refreshing dashboard:', error);
            showToast('Ошибка при обновлении', 'error');
        }
    }

    // --- DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', function () {
        if (checkAuth()) {
            loadDashboard();
        }
        // Исправление: обработчик для модалки уведомлений только если есть кнопка
        const notifyBtn = document.getElementById('openNotifyModalBtn');
        if (notifyBtn) {
            notifyBtn.onclick = openNotifyModal;
        }
        // Инициализируем кастомный dropdown при загрузке страницы с небольшой задержкой
        setTimeout(() => {
            initCategoryDropdown('');
        }, 100);
    });



    // --- Кнопки-иконки справа в строку ---
    // В разметке subscription-actions: заменяю flex-col на flex-row, gap-2, align-items-end
    // --- Модалка для уведомления всем (только для админа) ---
    (function () {
        const token = getToken();
        let isAdmin = false;
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                isAdmin = payload && payload.is_admin;
            } catch (e) { }
        }
        const btn = document.getElementById('openNotifyModalBtn');
        if (btn && isAdmin) {
            btn.classList.remove('hidden');
        }
    })();
    function openNotifyModal() {
        document.getElementById('notifyModal').classList.remove('hidden');
    }
    function closeNotifyModal() {
        document.getElementById('notifyModal').classList.add('hidden');
        document.getElementById('notifyAllForm').reset();
    }
    document.getElementById('openNotifyModalBtn').onclick = openNotifyModal;
    document.getElementById('notifyAllForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const msg = document.getElementById('notifyMessage').value.trim();
        if (!msg) return;
        try {
            const resp = await fetch('/api/dashboard/notify_all', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ message: msg })
            });
            if (resp.ok) {
                showToast('Уведомление отправлено всем!', 'success');
                closeNotifyModal();
            } else {
                showToast('Ошибка при отправке уведомления', 'error');
            }
        } catch (error) {
            showToast('Ошибка соединения', 'error');
        }
    });

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, checking auth...');
        if (checkAuth()) {
            console.log('Auth check passed, loading dashboard');
            loadDashboard();
        }
    });

    function setWelcomeUser() {
        const token = getToken();
        if (!token) return;
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (payload && payload.sub) {
                document.getElementById('welcomeUser').textContent = `Добро пожаловать, ${payload.sub}!`;
            }
        } catch (e) { }
    }

    document.getElementById('clearNotificationsBtn').onclick = openClearNotifModal;
    // --- Кастомное подтверждение удаления всех уведомлений ---
    function openClearNotifModal() {
        document.getElementById('clearNotifModal').classList.remove('hidden');
    }
    function closeClearNotifModal() {
        document.getElementById('clearNotifModal').classList.add('hidden');
    }
    document.getElementById('clearNotifYesBtn').onclick = async function () {
        closeClearNotifModal();
        try {
            const resp = await fetch('/api/dashboard/notifications/clear', {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (resp.ok) {
                showToast('Все уведомления удалены', 'success');
                await loadNotifications();
            } else {
                showToast('Ошибка при удалении уведомлений', 'error');
            }
        } catch (e) {
            showToast('Ошибка соединения', 'error');
        }
    };
</script>
{% endblock %}