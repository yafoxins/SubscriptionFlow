<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Subscription Manager{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/base.css">
    {% block extra_css %}{% endblock %}
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center space-x-2">
                        <i class="fas fa-chart-line text-2xl text-purple-600"></i>
                        <span class="text-xl font-bold text-gray-900">Subscription Manager</span>
                    </a>
                </div>

                <div class="flex items-center space-x-4" id="navbarAuthBlock">
                    {% if request.url.path == "/" %}
                    <a href="/login"
                        class="text-gray-600 hover:text-purple-600 px-3 py-2 rounded-md text-sm font-medium auth-btn">
                        <i class="fas fa-sign-in-alt mr-2"></i>–í–æ–π—Ç–∏
                    </a>
                    <a href="/register"
                        class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium auth-btn">
                        <i class="fas fa-user-plus mr-2"></i>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    </a>
                    {% else %}
                    <a href="/dashboard"
                        class="text-gray-600 hover:text-purple-600 px-3 py-2 rounded-md text-sm font-medium auth-btn">
                        <i class="fas fa-tachometer-alt mr-2"></i>–î–∞—à–±–æ—Ä–¥
                    </a>
                    <a href="/analytics"
                        class="text-gray-600 hover:text-purple-600 px-3 py-2 rounded-md text-sm font-medium auth-btn">
                        <i class="fas fa-chart-line mr-2"></i>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                    </a>
                    <a href="/settings"
                        class="text-gray-600 hover:text-purple-600 px-3 py-2 rounded-md text-sm font-medium auth-btn">
                        <i class="fas fa-cog mr-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </a>
                    <button onclick="logout()"
                        class="text-gray-600 hover:text-red-600 px-3 py-2 rounded-md text-sm font-medium auth-btn">
                        <i class="fas fa-sign-out-alt mr-2"></i>–í—ã–π—Ç–∏
                    </button>
                    {% endif %}
                    <!-- User info (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer-modern mt-12">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div class="text-center flex flex-col items-center gap-2">
                <div class="footer-divider"></div>
                <p class="footer-text flex items-center gap-2">
                    <span class="footer-icon"><i class="fas fa-copyright"></i></span>
                    2025 <a href="https://github.com/yafoxins" target="_blank" rel="noopener"
                        class="footer-link">Aleksandr Timkov</a> Subscription Manager. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
                </p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        function setToken(token) {
            localStorage.setItem('token', token);
        }

        function getToken() {
            return localStorage.getItem('token');
        }

        function getAuthHeaders() {
            const token = getToken();
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
    </script>

    <!-- --- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∏ –∞–≤—Ç–æ-—Ä–µ–¥–∏—Ä–µ–∫—Ç --- -->
    <script>
        (function () {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∏–∫–∞
            function getUserNameFromToken() {
                const token = getToken();
                if (!token) return null;
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload && payload.sub ? payload.sub : null;
                } catch (e) { return null; }
            }
            // –ù–∞ –≥–ª–∞–≤–Ω–æ–π: –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ dashboard
            if (window.location.pathname === '/') {
                const token = getToken();
                if (token) {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ (exp), –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    window.location.href = '/dashboard';
                }
            }
            // –í —à–∞–ø–∫–µ: –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –∏ –Ω–∏–∫
            const navbar = document.getElementById('navbarAuthBlock');
            if (navbar) {
                const token = getToken();
                let userName = null, isAdmin = false;
                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        userName = payload && payload.sub ? payload.sub : null;
                        isAdmin = payload && payload.is_admin;
                    } catch (e) { }
                }
                if (userName) {
                    // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –í–æ–π—Ç–∏/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–í—ã–π—Ç–∏
                    navbar.querySelectorAll('.auth-btn').forEach(el => el.style.display = 'none');
                    // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userBlock = document.createElement('div');
                    userBlock.className = 'relative group';
                    userBlock.innerHTML = `
                        <button id="userMenuBtn" class="flex items-center px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none">
                            <i class="fas fa-user-circle text-2xl text-purple-600 mr-2"></i>
                            <span class="font-medium">${userName}</span>
                            ${isAdmin ? '<span class="admin-badge ml-2"><i class="fas fa-crown"></i> admin</span>' : ''}
                            <i class="fas fa-chevron-down ml-2 text-xs"></i>
                        </button>
                        <div id="userMenuDropdown" class="hidden absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg py-2 z-50">
                            <a href="/dashboard" class="block px-4 py-2 text-gray-700 hover:bg-gray-50"><i class="fas fa-tachometer-alt mr-2"></i>–î–∞—à–±–æ—Ä–¥</a>
                            <a href="/analytics" class="block px-4 py-2 text-gray-700 hover:bg-gray-50"><i class="fas fa-chart-line mr-2"></i>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
                            <a href="/settings" class="block px-4 py-2 text-gray-700 hover:bg-gray-50"><i class="fas fa-cog mr-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                            ${isAdmin ? '<a href="/admin" class="block px-4 py-2 text-purple-700 hover:bg-purple-50"><i class="fas fa-user-shield mr-2"></i>–ê–¥–º–∏–Ω</a>' : ''}
                            <button onclick="logout()" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-50"><i class="fas fa-sign-out-alt mr-2"></i>–í—ã–π—Ç–∏</button>
                        </div>
                    `;
                    navbar.appendChild(userBlock);
                    // –õ–æ–≥–∏–∫–∞ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é
                    const btn = document.getElementById('userMenuBtn');
                    const dropdown = document.getElementById('userMenuDropdown');
                    btn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        dropdown.classList.toggle('hidden');
                    });
                    document.addEventListener('click', function (e) {
                        if (!userBlock.contains(e.target)) dropdown.classList.add('hidden');
                    });
                }
            }
        })();
    </script>

    {% block extra_js %}{% endblock %}

    <!-- Toast –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ–≥–¥–∞ –≤–Ω–∏–∑—É, –≤–Ω–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
    <div id="toastContainer"></div>
</body>

</html>